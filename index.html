<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chinese Text Reader (CPM, char-by-char)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f7f9; }
    .app-max { max-width: 920px; }
    .card { border-radius: 14px; }
    .reader-text {
      padding: 24px;
      font-size: 28px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      box-shadow: 0 1px 12px rgba(0,0,0,.04);
      min-height: 50vh;
      font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", "Heiti SC",
                   system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .muted-note { font-size: .9rem; color: #6c757d; }
    .btn-lg { border-radius: 10px; }
    .back-btn { position: static; top: 12px; right: 12px; z-index: 2; }
  </style>
</head>
<body>
  <div class="container py-4 app-max">

    <!-- Screen 1: Form -->
    <div id="screen-form">
      <div class="card p-4">
        <h1 class="h4 mb-3">Chinese Text Revealer</h1>
        <div class="mb-3">
          <label for="inputText" class="form-label">Paste Chinese text</label>
          <textarea id="inputText" class="form-control" rows="8" placeholder="在这里粘贴中文文本……"></textarea>
        </div>
        <div class="mb-2">
          <label for="speed" class="form-label d-flex justify-content-between">
            <span>Reading speed (characters per minute)</span>
            <span><strong id="speedVal">400</strong> cpm</span>
          </label>
          <input id="speed" type="range" class="form-range" min="60" max="1500" step="10" value="400">
          <div class="muted-note">Tip: 300–600 cpm is a reasonable starting range.</div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button id="goBtn" class="btn btn-primary btn-lg">Go</button>
        </div>
        <div class="mt-3 d-flex gap-2">
            <p><a href="https://chatgpt.com/c/68d9db8f-0274-8326-beba-6c2d05a355bc">ChatGPT link</a></p>
        </div>
      </div>
    </div>

    <!-- Screen 2: Reader -->
    <div id="screen-reader" class="d-none position-relative">
      <button id="backBtn" class="btn btn-outline-secondary back-btn">Back</button>
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <span class="me-3"><strong>Speed:</strong> <span id="liveCpm">–</span> cpm</span>
            <span class="me-3"><strong>Shown:</strong> <span id="shownChars">0</span> / <span id="totalChars">0</span></span>
          </div>
          <div class="d-flex gap-2">
            <button id="pauseBtn" class="btn btn-outline-primary btn-sm">Pause</button>
            <button id="restartBtn" class="btn btn-outline-dark btn-sm">Restart</button>
          </div>
        </div>

        <div id="readerText" class="reader-text mt-3"></div>
      </div>
    </div>

  </div>

  <script>
    // Elements
    const screenForm   = document.getElementById('screen-form');
    const screenReader = document.getElementById('screen-reader');
    const inputText    = document.getElementById('inputText');
    const speed        = document.getElementById('speed');
    const speedVal     = document.getElementById('speedVal');
    const goBtn        = document.getElementById('goBtn');

    const readerText   = document.getElementById('readerText');
    const backBtn      = document.getElementById('backBtn');
    const pauseBtn     = document.getElementById('pauseBtn');
    const restartBtn   = document.getElementById('restartBtn');
    const liveCpm      = document.getElementById('liveCpm');
    const shownCharsEl = document.getElementById('shownChars');
    const totalCharsEl = document.getElementById('totalChars');

    // Reactive slider label
    speed.addEventListener('input', () => {
      speedVal.textContent = speed.value;
      liveCpm.textContent = speed.value;
    });

    // Animation state
    let rafId = null;
    let paused = false;
    let lastTs = null;        // last timestamp from rAF
    let charProgress = 0;     // float, allows fractional progress for smoothness
    let shownIdx = 0;         // integer chars revealed
    let text = "";            // source text
    let totalChars = 0;

    function startLoop() {
      cancelLoop();
      lastTs = null;
      rafId = requestAnimationFrame(step);
    }
    function cancelLoop() {
      if (rafId != null) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
    }
    function resetReader() {
      cancelLoop();
      paused = false;
      lastTs = null;
      charProgress = 0;
      shownIdx = 0;
      readerText.textContent = "";
      shownCharsEl.textContent = "0";
      pauseBtn.textContent = "Pause";
    }

    function step(ts) {
      if (lastTs == null) lastTs = ts;
      const dt = (ts - lastTs) / 1000; // seconds
      lastTs = ts;

      const cpm = parseFloat(speed.value);
      const cps = cpm / 60;            // chars per second
      charProgress += cps * dt;

      const nextIdx = Math.min(totalChars, Math.floor(charProgress));
      if (nextIdx !== shownIdx) {
        shownIdx = nextIdx;
        readerText.textContent = text.slice(0, shownIdx);
        shownCharsEl.textContent = String(shownIdx);
      }

      if (shownIdx >= totalChars) {
        rafId = null;
        return; // finished
      }
      rafId = requestAnimationFrame(step);
    }

    // Handlers
    goBtn.addEventListener('click', () => {
      const raw = (inputText.value || '').trim();
      if (!raw) { alert('Please paste some Chinese text first.'); return; }

      text = raw;
      totalChars = text.length;
      totalCharsEl.textContent = String(totalChars);
      liveCpm.textContent = speed.value;

      // Switch screens
      screenForm.classList.add('d-none');
      screenReader.classList.remove('d-none');

      // Start revealing
      resetReader();
      startLoop();
    });

    backBtn.addEventListener('click', () => {
      cancelLoop();
      // Reset and go back
      readerText.textContent = '';
      screenReader.classList.add('d-none');
      screenForm.classList.remove('d-none');
    });

    pauseBtn.addEventListener('click', () => {
      if (!paused) {
        paused = true;
        cancelLoop();
        pauseBtn.textContent = 'Resume';
      } else {
        paused = false;
        lastTs = null; // resume fresh timing
        startLoop();
        pauseBtn.textContent = 'Pause';
      }
    });

    restartBtn.addEventListener('click', () => {
      resetReader();
      startLoop();
    });

    // If user adjusts speed mid-read, we already use current slider value each frame.
  </script>
</body>
</html>
